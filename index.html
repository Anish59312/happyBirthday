<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Birthday Cake</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: linear-gradient(to top, #111, #444);
        font-family: "Comic Sans MS", cursive, sans-serif;
        margin: 0;
        overflow-x: hidden;
      }

      /* Cake */
      .cake {
        position: relative;
        width: 90%;
        max-width: 400px;
        height: 160px;
        background: #ff99aa;
        border-radius: 10px;
        box-shadow: inset 0 -20px #d97777, 0 10px 20px rgba(0, 0, 0, 0.5);
        margin: 0 auto;
      }

      /* Candles container */
      .candles {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 0;
        display: flex;
        justify-content: space-evenly;
        padding: 0 10%; /* 10% margin on each side */
      }

      /* Candle */
      .candle {
        position: relative;
        bottom: 60px; /* Move candles above the cake */
        width: 20px;
        height: 60px;
        background: #fff;
        border-radius: 4px;
        box-shadow: inset 0 0 4px #aaa;
      }

      .wick {
        position: absolute;
        top: -12px;
        left: 50%;
        transform: translateX(-50%);
        width: 3px;
        height: 12px;
        background: #333;
      }

      .flame {
        position: absolute;
        top: -40px;
        left: 50%;
        transform: translateX(-50%);
        width: 18px;
        height: 36px;
        background: radial-gradient(
          ellipse at center,
          #ff0 0%,
          #f90 70%,
          transparent 100%
        );
        border-radius: 50%;
        animation: flicker 0.15s infinite alternate;
      }

      /* small blow visual effect */
      .cake {
        transition: transform 0.4s ease;
      }

      .blow-effect {
        transform: translateX(18px) scale(1.02);
      }

      @keyframes flicker {
        from {
          transform: translateX(-50%) scale(1);
          opacity: 0.9;
        }
        to {
          transform: translateX(-50%) scale(1.1);
          opacity: 1;
        }
      }

      .hidden {
        display: none;
      }

      /* Modal */
      .modal-content {
        background: #fff0f6;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 0 30px pink;
        animation: popIn 0.6s ease-out;
      }

      @keyframes popIn {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .modal-content h1 {
        font-size: 1.6rem;
        color: #ff4081;
        margin-bottom: 15px;
      }

      .modal-content img {
        width: 100%;
        max-width: 250px;
        border-radius: 12px;
        box-shadow: 0 0 20px #ffb6c1;
      }

      body.modal-open {
        overflow: hidden;
      }

      /* Confetti */
      .confetti {
        position: fixed;
        top: -10px;
        width: 8px;
        height: 16px;
        background: red;
        opacity: 0.9;
        animation: fall 3s linear infinite;
        z-index: 2000; /* ABOVE modal */
      }

      @keyframes fall {
        to {
          transform: translateY(100vh) rotate(360deg);
        }
      }
    </style>
  </head>
  <body
    class="d-flex flex-column justify-content-center align-items-center vh-100"
  >
    <!-- Cake with candles -->
    <div class="cake" id="cake">
      <div class="candles" id="candles"></div>
    </div>

    <div class="mt-5 text-white">Make a wish & blow the candles !</div>

    <button id="blowBtn" class="btn btn-warning mt-3" style="display: none">
      Blow
    </button>

    <!-- Bootstrap Modal -->
    <div class="modal fade" id="birthdayModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
          <h1>
            ðŸŽ‰ Happy Birthday <br />
            Hetu Didi ðŸŽ‰
          </h1>
          <img
            src="./brother-sister.jpg"
            alt="Birthday Image"
            class="img-fluid mb-3"
            ~
          />
          <p style="color: #d63384; font-size: 1rem">
            Wishing you joy, love & happiness always ðŸ’–
          </p>
        </div>
      </div>
    </div>

    <!-- Ready Modal -->
    <div
      class="modal fade show"
      id="readyModal"
      tabindex="-1"
      style="display: block"
      aria-modal="true"
      role="dialog"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
          <h2 class="mb-3">ðŸŽ‚ Ready to blow the candles?</h2>
          <button id="readyBtn" class="btn btn-primary btn-lg">Ready?</button>
        </div>
      </div>
    </div>

    <!-- Modal backdrop -->
    <div class="modal-backdrop fade show"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      const birthdayModal = new bootstrap.Modal(
        document.getElementById("birthdayModal")
      );

      const threshold = 0.007;

      //candles
      const candles = document.getElementById("candles");
      const candleCount = 4;

      for (let i = 0; i < candleCount; i++) {
        const candle = document.createElement("div");
        candle.className = "candle";

        const wick = document.createElement("div");
        wick.className = "wick";

        const flame = document.createElement("div");
        flame.className = "flame";

        candle.appendChild(wick);
        candle.appendChild(flame);
        candles.appendChild(candle);
      }

      function detectBlow(analyser, dataArray, threshold = 0.05) {
        analyser.getByteTimeDomainData(dataArray);

        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
          let val = (dataArray[i] - 128) / 128;
          sum += val * val;
        }

        const rms = Math.sqrt(sum / dataArray.length);
        return rms > threshold;
      }

      function onBlowDetected() {
        console.log("Blow detected!");

        // Example: hide flames
        const flamesNow = document.querySelectorAll(".flame");
        flamesNow.forEach((f) => f.classList.add("hidden"));

        checkAllBlown(); // If you have this function in your app
      }

      // Mic detection
      async function startMic() {
        navigator.mediaDevices
          .getUserMedia({ audio: true, video: false })
          .then(function (stream) {
            console.log("mic access allowed");

            const audioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
            audioContext.resume();
            const source = audioContext.createMediaStreamSource(stream);
            const analyser = audioContext.createAnalyser();
            source.connect(analyser);

            const dataArray = new Uint8Array(analyser.fftSize);

            function loop() {
              if (detectBlow(analyser, dataArray, threshold)) {
                onBlowDetected();
                return;
              }
              requestAnimationFrame(loop);
            }

            loop();
          })
          .catch(function (err) {
            console.log("Mic Error: ", err);
          });
      }

      // Confetti management variables
      let confettiActive = false;
      let confettiInterval = null;
      const CONFETTI_DURATION = 4000; // 8 seconds of confetti
      const CONFETTI_SPAWN_RATE = 200; // New confetti every 200ms

      function checkAllBlown() {
        // Query flames at the moment of checking so dynamically created candles are considered
        const currentFlames = document.querySelectorAll(".flame");
        const allOut = [...currentFlames].every((f) =>
          f.classList.contains("hidden")
        );
        if (allOut) {
          birthdayModal.show();
          launchConfetti();
        }
      }

      function createSingleConfetti() {
        const confetti = document.createElement("div");
        confetti.classList.add("confetti");
        confetti.style.left = Math.random() * window.innerWidth + "px";
        confetti.style.background = `hsl(${Math.random() * 360},100%,50%)`;
        confetti.style.animationDuration = 2 + Math.random() * 3 + "s";
        document.body.appendChild(confetti);

        // Remove confetti after animation completes
        setTimeout(() => {
          if (confetti.parentNode) {
            confetti.remove();
          }
        }, 5000);
      }

      function launchConfetti() {
        if (confettiActive) return; // Prevent multiple confetti sessions

        confettiActive = true;
        console.log("ðŸŽŠ Confetti started!");

        // Create initial burst of confetti
        for (let i = 0; i < 15; i++) {
          setTimeout(() => createSingleConfetti(), i * 50);
        }

        // Continue spawning confetti at regular intervals
        confettiInterval = setInterval(() => {
          for (let i = 0; i < 3; i++) {
            createSingleConfetti();
          }
        }, CONFETTI_SPAWN_RATE);

        // Stop confetti after time limit
        setTimeout(() => {
          stopConfetti();
        }, CONFETTI_DURATION);
      }

      function stopConfetti() {
        if (confettiInterval) {
          clearInterval(confettiInterval);
          confettiInterval = null;
        }
        confettiActive = false;
        console.log("ðŸŽŠ Confetti stopped!");
      }

      // Helper to simulate a blow from UI
      function simulateBlow() {
        // brief visual nudge on the cake
        const cake = document.getElementById("cake");
        cake.classList.add("blow-effect");
        setTimeout(() => cake.classList.remove("blow-effect"), 500);

        // Trigger the same logic as a detected mic-blow
        onBlowDetected();

        // disable button after use
        const btn = document.getElementById("blowBtn");
        if (btn) btn.disabled = true;
      }

      // Show blow button and start mic 2 seconds after the page finishes loading
      window.addEventListener("load", () => {
        setTimeout(() => {
          const btn = document.getElementById("blowBtn");
          if (btn) {
            btn.style.display = "inline-block";
            btn.addEventListener("click", simulateBlow);
          }

          // Start microphone detection after the small delay as requested
          startMic();
        }, 2000);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const readyModal = document.getElementById("readyModal");
        const readyBtn = document.getElementById("readyBtn");
        const backdrop = document.querySelector(".modal-backdrop");

        // Lock scrolling
        document.body.classList.add("modal-open");

        readyBtn.addEventListener("click", () => {
          // Hide modal
          readyModal.style.display = "none";
          readyModal.classList.remove("show");
          if (backdrop) backdrop.remove();

          // Unlock scrolling
          document.body.classList.remove("modal-open");

          // Show blow button and start mic
          const btn = document.getElementById("blowBtn");
          if (btn) {
            btn.style.display = "inline-block";
            btn.addEventListener("click", () => {
              simulateBlow();
              startMic(); // Mic starts only after user clicks
              btn.disabled = true;
            });
          }
        });
      });
    </script>
  </body>
</html>
